let csrfToken=null,csrfTokenPromise=null;function setCsrfToken(e){csrfToken=e||null,document.querySelectorAll('input[name="csrf_token"]').forEach(e=>{e.value=csrfToken||""})}function refreshCsrfToken(){return csrfTokenPromise=fetch("server/auth.php?action=check",{credentials:"include"}).then(e=>e.json()).then(e=>(setCsrfToken(e.csrfToken),csrfToken)).catch(()=>(setCsrfToken(null),null)).finally(()=>{csrfTokenPromise=null}),csrfTokenPromise}function ensureCsrfToken(){return csrfToken?Promise.resolve(csrfToken):csrfTokenPromise||refreshCsrfToken()}function csrfFetch(e,t={}){const n={...t};n.credentials=n.credentials||"include";return"GET"===(n.method||"GET").toUpperCase()?fetch(e,n):ensureCsrfToken().then(()=>csrfToken?(n.headers={...n.headers||{}},n.headers["X-CSRF-Token"]=csrfToken,fetch(e,n)):Promise.reject(new Error("CSRF token unavailable")))}document.addEventListener("DOMContentLoaded",()=>{AOS.init();const e={fr:{nav_about:"À propos",nav_how_it_works:"Comment ça marche",nav_solutions:"Nos Solutions",nav_ai_advisor:"✨ Conseiller IA",nav_account:"Mon Compte",nav_get_quote:"Obtenir un devis",nav_about_mobile:"À propos",nav_how_it_works_mobile:"Comment ça marche",nav_solutions_mobile:"Nos Solutions",nav_ai_advisor_mobile:"✨ Conseiller IA",nav_account_mobile:"Mon Compte",nav_get_quote_mobile:"Obtenir un devis",hero_title:"Du traditionnel au smart - connectez votre ferme à l'avenir.",hero_subtitle:"Solutions de modernisation abordables pour une agriculture plus efficace.",hero_button:"Découvrir nos solutions",summary_about_title:"Notre Vision : Un Futur Intelligent",summary_about_desc:"Nous démocratisons l'agriculture intelligente. Découvrez comment notre engagement envers l'innovation \"retrofit\" relève les défis mondiaux et crée un avenir durable pour tous.",learn_more_about_us:"En savoir plus sur nous",summary_solutions_title:"Solutions Modulaires Puissantes",summary_solutions_desc:"Irrigation intelligente, contrôle des pompes, surveillance environnementale. Explorez nos solutions conçues pour optimiser vos ressources et maximiser vos rendements.",explore_solutions:"Explorer nos solutions",summary_ai_advisor_title:"Votre Agronome Personnel",summary_ai_advisor_desc:"Un problème avec vos cultures ? Décrivez-le à notre Conseiller IA et recevez une analyse et des recommandations instantanées pour protéger votre récolte.",try_ai_advisor:"Essayer le conseiller IA",summary_contact_title:"Prêt à moderniser votre ferme ?",summary_contact_desc:"Discutons de vos besoins. Contactez-nous dès aujourd'hui pour obtenir un devis personnalisé et découvrir comment FarmLink peut transformer votre exploitation.",contact_us_button:"Contactez-nous",testimonials_title:"Ce que disent nos agriculteurs",testimonial_1_text:"\"FarmLink a transformé ma gestion de l'eau. J'économise du temps et de l'argent, et mes rendements n'ont jamais été aussi bons.\"",testimonial_1_name:"Karim A.",testimonial_1_location:"Agriculteur, Sidi Bouzid",testimonial_2_text:'"L\'installation a été incroyablement simple sur mon équipement existant. Le panneau de contrôle est très intuitif."',testimonial_2_name:"Fatma M.",testimonial_2_location:"Exploitante d'oliveraie, Sfax",testimonial_3_text:"\"Le conseiller IA est un véritable plus. Il m'a aidé à identifier un problème de ravageurs avant qu'il ne se propage. C'est l'avenir !\"",testimonial_3_name:"Youssef B.",testimonial_3_location:"Serriste, Kairouan",footer_copyright:"&copy; 2025 FarmLink. Tous droits réservés.",about_main_title:"L'Agriculture de Demain, Une Récolte à la Fois.",about_vision_title:"Notre Vision : Un futur où chaque ferme est intelligente.",about_intro_text:"Chez FarmLink, nous voyons l'agriculture non pas comme une industrie du passé, mais comme la technologie la plus essentielle de l'avenir. Notre mission est de démocratiser l'agriculture intelligente.",about_commitment_title:'Notre Engagement : Affronter les défis mondiaux avec l\'innovation "retrofit".',about_commitment_text:"Dans un monde où les ressources sont limitées et les défis climatiques s'intensifient, la mission de FarmLink est plus vitale que jamais.",how_it_works_title:"Comment ça marche ?",step1_title:'Installation "Retrofit"',step1_desc:"Nous installons nos modules sur votre équipement existant, sans remplacement coûteux.",step2_title:"Connexion au Cloud",step2_desc:"Les capteurs envoient les données en temps réel à notre plateforme sécurisée.",step3_title:"Contrôle & Optimisation",step3_desc:"Vous gérez tout depuis le panneau de contrôle et recevez des recommandations de l'IA.",solutions_title:"Nos Solutions Modulaires",solution_irrigation_title:"Irrigation Intelligente",solution_irrigation_desc:"Optimisez votre consommation d'eau avec des vannes intelligentes et une planification automatisée.",solution_pump_title:"Contrôle des Pompes",solution_pump_desc:"Gérez vos pompes à distance et surveillez le débit et la pression en temps réel.",solution_env_title:"Surveillance Environnementale",solution_env_desc:"Prenez des décisions éclairées grâce aux données des capteurs de température, d'humidité et de sol.",ai_advisor_title:"✨ Conseiller Agricole IA",ai_welcome:"Bonjour ! Posez-moi une question sur vos cultures ou envoyez-moi une photo.",privacyNote:"Confidentialité garantie : Toute l'analyse est effectuée sur votre appareil.",contact_title:"Contactez-nous",contact_intro:"Une question ? Un projet ? N'hésitez pas à nous contacter. Notre équipe est prête à vous aider à franchir le pas vers l'agriculture intelligente.",contact_name:"Nom",contact_email:"Email",contact_phone:"Numéro de téléphone",contact_message:"Message",contact_send:"<i class='fas fa-paper-plane mr-2'></i> Envoyer le Message",contact_sending:"Envoi du message…",contact_success_message:"Votre message a été envoyé avec succès.",contact_error_message:"Impossible d'envoyer le message. Vérifiez les champs et réessayez.",contact_network_error:"Une erreur réseau est survenue. Veuillez réessayer.",account_title:"Mon Compte",auth_login_title:"Se connecter",auth_login_btn:"Se connecter",auth_login_instructions:"Saisissez votre nom d'utilisateur et votre mot de passe pour accéder à votre espace sécurisé FarmLink.",auth_username_label:"Nom d'utilisateur",auth_password_label:"Mot de passe",auth_register_prompt:"Pas encore de compte ? <a data-route='register' class='text-brand-green-400 font-bold'>Créer un compte</a>",auth_register_title:"Créer un compte",auth_register_btn:"Créer le compte",auth_register_instructions:"Tous les champs sont obligatoires. Utilisez un mot de passe d'au moins huit caractères.",auth_last_name_label:"Nom",auth_first_name_label:"Prénom",auth_email_label:"Email",auth_phone_label:"Téléphone",auth_region_label:"Région",auth_last_name_placeholder:"Nom",auth_first_name_placeholder:"Prénom",auth_email_placeholder:"Email",auth_phone_placeholder:"Numéro de téléphone",auth_region_placeholder:"Région",auth_username_placeholder:"Nom d'utilisateur",auth_password_placeholder:"Mot de passe",auth_login_prompt:"Déjà un compte ? <a data-route='account' class='text-brand-blue-500 font-bold'>Se connecter</a>",products_section_title:"Mes Produits",product_form_instructions:"Renseignez les informations clés de votre produit pour mettre à jour le tableau de bord.",product_name_label:"Nom du produit",product_quantity_label:"Quantité",product_phone_label:"Téléphone GSM",product_ph_label:"pH",product_rain_label:"Pluie",product_humidity_label:"Humidité",product_soil_humidity_label:"Humidité du sol",product_light_label:"Lumière",product_valve_open_label:"Valve ouverte",product_valve_angle_label:"Angle de valve",product_name_placeholder:"Nom du produit",product_quantity_placeholder:"Quantité",product_phone_placeholder:"Téléphone GSM",product_ph_placeholder:"pH",product_rain_placeholder:"Pluie (mm)",product_humidity_placeholder:"Humidité (%)",product_soil_humidity_placeholder:"Humidité du sol (%)",product_light_placeholder:"Lumière (lux)",product_valve_angle_placeholder:"Angle de valve",add_product_btn:"Ajouter",logout_btn:"Se déconnecter",profile_form_instructions:"Mettez à jour vos coordonnées FarmLink. Tous les champs sont obligatoires.",profile_last_name_label:"Nom",profile_first_name_label:"Prénom",profile_email_label:"Email",profile_phone_label:"Téléphone",profile_region_label:"Région",profile_update_button:"Mettre à jour",context_agricole:"\n                ### SUJET: AGRICULTURE EN TUNISIE ###\n                L'agriculture en Tunisie fait face à des défis comme la sécheresse et la salinité des sols. Les cultures principales sont les olives, les céréales, les dattes et les agrumes. La bonne gestion de l'eau est cruciale.\n                ### PROBLÈME: FEUILLES JAUNES (CHLOROSE) ###\n                Les feuilles jaunes sur une plante sont souvent un signe de carence en nutriments ou de maladie.\n                - Sur les tomates, des taches jaunes peuvent indiquer le mildiou, surtout si le temps est humide. Une autre cause est la carence en azote, qui fait jaunir les vieilles feuilles en premier.\n                - Sur les oliviers, le jaunissement peut être causé par un manque d'eau, un sol trop calcaire, ou une maladie comme la verticilliose.\n                - Sur les agrumes (citronniers, orangers), des feuilles jaunes avec des nervures vertes indiquent souvent une carence en fer (chlorose ferrique), fréquente dans les sols calcaires tunisiens. Solution : apport de chélate de fer.\n                ### PROBLÈME: PARASITES COMMUNS ###\n                - Les pucerons sont de petits insectes verts ou noirs qui sucent la sève, affaiblissant la plante et transmettant des maladies. Solution : savon noir dilué ou insecticide naturel.\n                - La mouche de l'olivier pond ses œufs dans les olives, provoquant leur chute. Solution : surveillance avec des pièges (phéromones) et traitement si nécessaire.\n                - L'araignée rouge se développe par temps chaud et sec et crée de fines toiles sous les feuilles. Solution : pulvérisation d'eau sur le feuillage pour augmenter l'humidité.\n            "},en:{nav_about:"About",nav_how_it_works:"How It Works",nav_solutions:"Solutions",nav_ai_advisor:"✨ AI Advisor",nav_account:"My Account",nav_get_quote:"Get a Quote",nav_about_mobile:"About",nav_how_it_works_mobile:"How It Works",nav_solutions_mobile:"Solutions",nav_ai_advisor_mobile:"✨ AI Advisor",nav_account_mobile:"My Account",nav_get_quote_mobile:"Get a Quote",hero_title:"From traditional to smart – connect your farm to the future.",hero_subtitle:"Affordable retrofit solutions for more efficient farming.",hero_button:"Discover our solutions",summary_about_title:"Our Vision: A Smart Future",summary_about_desc:"We are democratizing smart agriculture. Discover how our commitment to 'retrofit' innovation addresses global challenges and creates a sustainable future for all.",learn_more_about_us:"Learn More About Us",summary_solutions_title:"Powerful Modular Solutions",summary_solutions_desc:"Smart irrigation, pump control, environmental monitoring. Explore our solutions designed to optimize your resources and maximize your yields.",explore_solutions:"Explore Our Solutions",summary_ai_advisor_title:"Your Personal Agronomist",summary_ai_advisor_desc:"Have a problem with your crops? Describe it to our AI Advisor and receive an instant analysis and recommendations to protect your harvest.",try_ai_advisor:"Try the AI Advisor",summary_contact_title:"Ready to upgrade your farm?",summary_contact_desc:"Let's discuss your needs. Contact us today for a personalized quote and find out how FarmLink can transform your operation.",contact_us_button:"Contact Us",testimonials_title:"What Our Farmers Say",testimonial_1_text:'"FarmLink has transformed my water management. I save time and money, and my yields have never been better."',testimonial_1_name:"Karim A.",testimonial_1_location:"Farmer, Sidi Bouzid",testimonial_2_text:'"The installation was incredibly simple on my existing equipment. The control panel is very intuitive."',testimonial_2_name:"Fatma M.",testimonial_2_location:"Olive grove owner, Sfax",testimonial_3_text:'"The AI advisor is a real game-changer. It helped me identify a pest problem before it spread. This is the future!"',testimonial_3_name:"Youssef B.",testimonial_3_location:"Greenhouse farmer, Kairouan",footer_copyright:"&copy; 2025 FarmLink. All rights reserved.",about_main_title:"The Future of Farming, One Harvest at a Time.",about_vision_title:"Our Vision: A future where every farm is smart.",about_intro_text:"At FarmLink, we see agriculture not as an industry of the past, but as the most essential technology of the future. Our mission is to democratize smart farming.",about_commitment_title:"Our Commitment: Tackling global challenges with 'retrofit' innovation.",about_commitment_text:"In a world of limited resources and intensifying climate challenges, FarmLink's mission is more vital than ever.",how_it_works_title:"How It Works?",step1_title:'"Retrofit" Installation',step1_desc:"We install our modules on your existing equipment, without costly replacements.",step2_title:"Cloud Connection",step2_desc:"Sensors send real-time data to our secure platform.",step3_title:"Control & Optimization",step3_desc:"You manage everything from the control panel and receive AI-powered recommendations.",solutions_title:"Our Modular Solutions",solution_irrigation_title:"Smart Irrigation",solution_irrigation_desc:"Optimize your water consumption with smart valves and automated scheduling.",solution_pump_title:"Pump Control",solution_pump_desc:"Manage your pumps remotely and monitor flow and pressure in real time.",solution_env_title:"Environmental Monitoring",solution_env_desc:"Make informed decisions with data from temperature, humidity, and soil sensors.",ai_advisor_title:"✨ AI Farming Advisor",ai_welcome:"Hello! Ask me a question about your crops or send me a photo.",privacyNote:"Privacy guaranteed: All analysis is performed on your device.",contact_title:"Contact Us",contact_intro:"A question? A project? Don't hesitate to contact us. Our team is ready to help you take the step towards smart agriculture.",contact_name:"Name",contact_email:"Email",contact_phone:"Phone Number",contact_message:"Message",contact_send:"<i class='fas fa-paper-plane mr-2'></i> Send Message",contact_sending:"Sending message…",contact_success_message:"Your message was sent successfully.",contact_error_message:"We couldn't send your message. Please check the fields and try again.",contact_network_error:"A network error occurred. Please try again.",account_title:"My Account",auth_login_title:"Log In",auth_login_btn:"Log In",auth_login_instructions:"Enter your username and password to access your secure FarmLink space.",auth_username_label:"Username",auth_password_label:"Password",auth_register_prompt:"Don't have an account yet? <a data-route='register' class='text-brand-green-400 font-bold'>Create an account</a>",auth_register_title:"Create an Account",auth_register_btn:"Create Account",auth_register_instructions:"All fields are required. Use a password with at least eight characters.",auth_last_name_label:"Last Name",auth_first_name_label:"First Name",auth_email_label:"Email",auth_phone_label:"Phone",auth_region_label:"Region",auth_last_name_placeholder:"Last Name",auth_first_name_placeholder:"First Name",auth_email_placeholder:"Email",auth_phone_placeholder:"Phone Number",auth_region_placeholder:"Region",auth_username_placeholder:"Username",auth_password_placeholder:"Password",auth_login_prompt:"Already have an account? <a data-route='account' class='text-brand-blue-500 font-bold'>Log In</a>",products_section_title:"My Products",product_form_instructions:"Provide key product details to update the dashboard.",product_name_label:"Product Name",product_quantity_label:"Quantity",product_phone_label:"Mobile Phone",product_ph_label:"pH",product_rain_label:"Rain",product_humidity_label:"Humidity",product_soil_humidity_label:"Soil Humidity",product_light_label:"Light",product_valve_open_label:"Valve Open",product_valve_angle_label:"Valve Angle",product_name_placeholder:"Product name",product_quantity_placeholder:"Quantity",product_phone_placeholder:"Mobile phone",product_ph_placeholder:"pH",product_rain_placeholder:"Rain (mm)",product_humidity_placeholder:"Humidity (%)",product_soil_humidity_placeholder:"Soil humidity (%)",product_light_placeholder:"Light (lux)",product_valve_angle_placeholder:"Valve angle",add_product_btn:"Add",logout_btn:"Log Out",profile_form_instructions:"Update your FarmLink contact details. All fields are required.",profile_last_name_label:"Last Name",profile_first_name_label:"First Name",profile_email_label:"Email",profile_phone_label:"Phone",profile_region_label:"Region",profile_update_button:"Update",context_agricole:"\n                ### SUBJECT: AGRICULTURE IN TUNISIA ###\n                Agriculture in Tunisia faces challenges like drought and soil salinity. Main crops include olives, cereals, dates, and citrus fruits. Good water management is crucial.\n                ### PROBLEM: YELLOW LEAVES (CHLOROSIS) ###\n                Yellow leaves on a plant are often a sign of nutrient deficiency or disease.\n                - On tomatoes, yellow spots can indicate downy mildew, especially in humid weather. Another cause is nitrogen deficiency, which yellows older leaves first.\n                - On olive trees, yellowing can be caused by lack of water, soil that is too calcareous, or a disease like Verticillium wilt.\n                - On citrus trees (lemon, orange), yellow leaves with green veins often indicate an iron deficiency (iron chlorosis), common in Tunisian calcareous soils. Solution: apply iron chelate.\n            "},ar:{nav_about:"نبذة عنا",nav_how_it_works:"كيف نعمل",nav_solutions:"حلولنا",nav_ai_advisor:"✨ المستشار الذكي",nav_account:"حسابي",nav_get_quote:"اطلب عرض سعر",nav_about_mobile:"نبذة عنا",nav_how_it_works_mobile:"كيف نعمل",nav_solutions_mobile:"حلولنا",nav_ai_advisor_mobile:"✨ المستشار الذكي",nav_account_mobile:"حسابي",nav_get_quote_mobile:"اطلب عرض سعر",hero_title:"من الزراعة التقليدية إلى الذكية – اربط مزرعتك بالمستقبل.",hero_subtitle:"حلول تحديث بأسعار معقولة لزراعة أكثر كفاءة.",hero_button:"اكتشف حلولنا",summary_about_title:"رؤيتنا: مستقبل ذكي",summary_about_desc:'نحن نعمل على نشر الزراعة الذكية. اكتشف كيف يواجه التزامنا بالابتكار "التحديثي" التحديات العالمية ويخلق مستقبلًا مستدامًا للجميع.',learn_more_about_us:"اعرف المزيد عنا",summary_solutions_title:"حلول معيارية قوية",summary_solutions_desc:"الري الذكي، التحكم في المضخات، المراقبة البيئية. استكشف حلولنا المصممة لتحسين مواردك وزيادة غلتك.",explore_solutions:"استكشف حلولنا",summary_ai_advisor_title:"مهندسك الزراعي الشخصي",summary_ai_advisor_desc:"هل لديك مشكلة في محاصيلك؟ صفها لمستشارنا الذكي واحصل على تحليل وتوصيات فورية لحماية محصولك.",try_ai_advisor:"جرب المستشار الذكي",summary_contact_title:"هل أنت مستعد لتحديث مزرعتك؟",summary_contact_desc:"دعنا نناقش احتياجاتك. اتصل بنا اليوم للحصول على عرض أسعار شخصي واكتشف كيف يمكن لـ FarmLink تحويل عملياتك الزراعية.",contact_us_button:"اتصل بنا",testimonials_title:"ماذا يقول مزارعونا",testimonial_1_text:'"لقد غيرت FarmLink إدارة المياه لدي. أوفر الوقت والمال، ومحاصيلي لم تكن أفضل من أي وقت مضى."',testimonial_1_name:"كريم أ.",testimonial_1_location:"مزارع، سيدي بوزيد",testimonial_2_text:'"كان التركيب بسيطًا بشكل لا يصدق على معداتي الحالية. لوحة التحكم سهلة الاستخدام للغاية."',testimonial_2_name:"فاطمة م.",testimonial_2_location:"صاحبة بستان زيتون، صفاقس",testimonial_3_text:'"المستشار الذكي هو إضافة حقيقية. لقد ساعدني في تحديد مشكلة الآفات قبل انتشارها. هذا هو المستقبل!"',testimonial_3_name:"يوسف ب.",testimonial_3_location:"مزارع صوبات، القيروان",footer_copyright:"&copy; 2025 FarmLink. جميع الحقوق محفوظة.",about_main_title:"زراعة الغد، حصادًا بعد حصاد.",about_vision_title:"رؤيتنا: مستقبل تكون فيه كل مزرعة ذكية.",about_intro_text:"في FarmLink، مهمتنا هي جعل الزراعة الذكية في متناول الجميع.",about_commitment_title:'التزامنا: مواجهة التحديات العالمية بابتكار "التحديث".',about_commitment_text:"في عالم تتزايد فيه ندرة الموارد وتتفاقم التحديات المناخية، أصبحت مهمة FarmLink أكثر أهمية من أي وقت مضى.",how_it_works_title:"كيف نعمل؟",step1_title:'تركيب "تحديثي"',step1_desc:"نقوم بتركيب وحداتنا على معداتك الحالية، دون الحاجة إلى استبدالها بالكامل.",step2_title:"الاتصال السحابي",step2_desc:"ترسل المستشعرات البيانات في الوقت الفعلي إلى منصتنا الآمنة.",step3_title:"التحكم والتحسين",step3_desc:"يمكنك إدارة كل شيء من لوحة التحكم وتلقي توصيات مدعومة بالذكاء الاصطناعي.",solutions_title:"حلولنا المعيارية",solution_irrigation_title:"الري الذكي",solution_irrigation_desc:"حسّن استهلاكك للمياه باستخدام الصمامات الذكية والجدولة الآلية.",solution_pump_title:"التحكم في المضخات",solution_pump_desc:"أدر مضخاتك عن بعد وراقب التدفق والضغط في الوقت الفعلي.",solution_env_title:"المراقبة البيئية",solution_env_desc:"اتخذ قرارات مستنيرة بفضل بيانات مستشعرات درجة الحرارة والرطوبة والتربة.",ai_advisor_title:"✨ المستشار الزراعي الذكي",ai_welcome:"مرحباً! اسألني سؤالاً عن محاصيلك أو أرسل لي صورة.",privacyNote:"الخصوصية مضمونة: يتم إجراء جميع التحليلات على جهازك.",contact_title:"اتصل بنا",contact_intro:"سؤال؟ مشروع؟ لا تتردد في الاتصال بنا. فريقنا مستعد لمساعدتك على اتخاذ الخطوة نحو الزراعة الذكية.",contact_name:"الاسم",contact_email:"البريد الإلكتروني",contact_phone:"رقم الهاتف",contact_message:"الرسالة",contact_send:"<i class='fas fa-paper-plane ml-2'></i> إرسال الرسالة",contact_sending:"جارٍ إرسال الرسالة…",contact_success_message:"تم إرسال رسالتك بنجاح.",contact_error_message:"تعذر إرسال الرسالة. تحقق من الحقول وحاول مرة أخرى.",contact_network_error:"حدث خطأ في الشبكة. حاول مجددًا.",account_title:"حسابي",auth_login_title:"تسجيل الدخول",auth_login_btn:"تسجيل الدخول",auth_login_instructions:"أدخل اسم المستخدم وكلمة المرور للوصول إلى مساحة FarmLink الآمنة.",auth_username_label:"اسم المستخدم",auth_password_label:"كلمة المرور",auth_register_prompt:"لا يوجد لديك حساب بعد؟ <a data-route='register' class='text-brand-green-400 font-bold'>إنشاء حساب</a>",auth_register_title:"إنشاء حساب",auth_register_btn:"إنشاء الحساب",auth_register_instructions:"جميع الحقول مطلوبة. استخدم كلمة مرور لا تقل عن ثمانية أحرف.",auth_last_name_label:"اللقب",auth_first_name_label:"الاسم",auth_email_label:"البريد الإلكتروني",auth_phone_label:"الهاتف",auth_region_label:"المنطقة",auth_last_name_placeholder:"اللقب",auth_first_name_placeholder:"الاسم الأول",auth_email_placeholder:"البريد الإلكتروني",auth_phone_placeholder:"رقم الهاتف",auth_region_placeholder:"المنطقة",auth_username_placeholder:"اسم المستخدم",auth_password_placeholder:"كلمة المرور",auth_login_prompt:"لديك حساب بالفعل؟ <a data-route='account' class='text-brand-blue-500 font-bold'>تسجيل الدخول</a>",products_section_title:"منتجاتي",product_form_instructions:"أدخل بيانات المنتج الأساسية لتحديث لوحة التحكم.",product_name_label:"اسم المنتج",product_quantity_label:"الكمية",product_phone_label:"هاتف محمول",product_ph_label:"درجة الحموضة",product_rain_label:"الأمطار",product_humidity_label:"الرطوبة",product_soil_humidity_label:"رطوبة التربة",product_light_label:"الإضاءة",product_valve_open_label:"الصمام مفتوح",product_valve_angle_label:"زاوية الصمام",product_name_placeholder:"اسم المنتج",product_quantity_placeholder:"الكمية",product_phone_placeholder:"هاتف محمول",product_ph_placeholder:"درجة الحموضة",product_rain_placeholder:"الأمطار (مم)",product_humidity_placeholder:"الرطوبة (%)",product_soil_humidity_placeholder:"رطوبة التربة (%)",product_light_placeholder:"الإضاءة (لوكس)",product_valve_angle_placeholder:"زاوية الصمام",add_product_btn:"أضف",logout_btn:"تسجيل الخروج",profile_form_instructions:"حدّث بيانات التواصل الخاصة بك في FarmLink. جميع الحقول مطلوبة.",profile_last_name_label:"اللقب",profile_first_name_label:"الاسم",profile_email_label:"البريد الإلكتروني",profile_phone_label:"الهاتف",profile_region_label:"المنطقة",profile_update_button:"تحديث",context_agricole:"\n                ### الموضوع: الزراعة في تونس ###\n                تواجه الزراعة في تونس تحديات مثل الجفاف وملوحة التربة. المحاصيل الرئيسية تشمل الزيتون والحبوب والتمور والحمضيات. الإدارة الجيدة للمياه أمر بالغ الأهمية.\n            "}};let t="fr";const n=document.documentElement,o=document.body,a=document.getElementById("language-switcher"),r=document.getElementById("menu-btn"),s=document.getElementById("mobile-menu"),i=document.getElementById("theme-toggle"),l=document.getElementById("theme-icon-light"),c=document.getElementById("theme-icon-dark"),u=(document.querySelectorAll(".nav-link, #mobile-menu a"),document.querySelectorAll(".button, .cta-button"),document.body.dataset.accountLink||"account.php"),d=document.body.dataset.registerLink||"register.php",m=document.body.dataset.profileLink||"profile.php",_=()=>{document.querySelectorAll('[data-route="account"]').forEach(e=>{e.setAttribute("href",u)}),document.querySelectorAll('[data-route="register"]').forEach(e=>{e.setAttribute("href",d)}),document.querySelectorAll('[data-route="profile"]').forEach(e=>{e.setAttribute("href",m)})},p=o=>{t=o,n.lang=o,n.dir="ar"===o?"rtl":"ltr",document.querySelectorAll("[data-translate]").forEach(t=>{const n=t.getAttribute("data-translate");t.dataset.original||(t.dataset.original=t.innerHTML);const a=e[o]&&e[o][n];a?t.innerHTML=a:(t.innerHTML=t.dataset.original,console.warn(`Missing translation for key '${n}' in language '${o}'`))}),document.querySelectorAll("[data-translate-placeholder]").forEach(t=>{const n=t.getAttribute("data-translate-placeholder");e[o]&&e[o][n]&&t.setAttribute("placeholder",e[o][n])})},h=e=>{"dark"===e?(o.classList.add("dark"),l&&l.classList.add("hidden"),c&&c.classList.remove("hidden")):(o.classList.remove("dark"),l&&l.classList.remove("hidden"),c&&c.classList.add("hidden"))},g=localStorage.getItem("language")||"fr",v=localStorage.getItem("theme")||"dark";a&&(a.value=g),p(g),_(),h(v);const f=window.location.pathname.split("/").pop()||"index.php";if(document.querySelectorAll(".nav-link").forEach(e=>{e.getAttribute("href")===f&&e.classList.add("active")}),a&&a.addEventListener("change",e=>{const t=e.target.value;localStorage.setItem("language",t),p(t),_()}),r&&s&&r.addEventListener("click",()=>s.classList.toggle("hidden")),i&&i.addEventListener("click",()=>{const e=o.classList.contains("dark")?"light":"dark";localStorage.setItem("theme",e),h(e)}),document.getElementById("ai-advisor")){let w={image:null,ready:!1},x=null;const k=document.getElementById("ai-input-form"),T=document.getElementById("text-input"),S=document.getElementById("fileInput"),A=document.getElementById("webcamBtn"),B=document.getElementById("captureBtn"),F=document.getElementById("image-preview-wrapper"),N=document.getElementById("previewImg"),P=document.getElementById("cam"),O=document.getElementById("ai-response-text"),M=document.getElementById("ai-spinner"),q=document.getElementById("progress-container"),j=document.getElementById("progressBar");function y(e){M.classList.toggle("hidden",!e)}function b(e){j&&(j.style.width=`${e}%`)}function E(e){T.disabled=!e,k.querySelector('button[type="submit"]').disabled=!e,T.placeholder=e?"Posez votre question ici...":"Chargement des modèles IA..."}function L(e){F.classList.remove("hidden"),N.src=e,N.hidden=!1,P.hidden=!0,B.classList.add("hidden"),x&&(x.getTracks().forEach(e=>e.stop()),x=null,A.classList.remove("active")),async function(e){if(e&&e.src)if(w.ready&&w.image){y(!0),O.textContent="Analyse de l'image en cours...";try{const t=await w.image.classify(e);if(t&&t.length>0){const e=t[0].className.split(",")[0],n=`Quelles sont les causes des taches sur une feuille de ${e} ?`;T.value=n,T.style.height="auto",T.style.height=T.scrollHeight+"px",O.innerHTML=`<p>J'ai identifié un(e) <strong>${e}</strong>. J'ai préparé une question pour vous. Appuyez sur Envoyer pour obtenir une analyse.</p>`}else O.innerHTML="<p>Aucun objet n'a pu être identifié. Essayez une autre photo.</p>"}catch(e){console.error("Erreur MobileNet:",e),O.textContent="Une erreur est survenue lors de l'analyse de l'image."}finally{y(!1)}}else O.textContent="Le modèle IA image n'est pas encore prêt."}(N)}k.addEventListener("submit",e=>{e.preventDefault(),async function(e){if(e.trim()){y(!0),O.textContent="",F.classList.add("hidden");try{const t=await fetch("server/ai.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:e})}),n=await t.json();n&&n.answer?O.textContent=n.answer:O.textContent="Aucune réponse reçue."}catch(e){console.error("Erreur IA:",e),O.textContent="Une erreur est survenue lors de l'analyse."}finally{y(!1)}}}(T.value),T.value="",T.style.height="40px"}),S.addEventListener("change",e=>{const t=e.target.files[0];if(t){const e=new FileReader;e.onload=e=>L(e.target.result),e.readAsDataURL(t)}}),A&&A.addEventListener("click",async function(){if(x)return x.getTracks().forEach(e=>e.stop()),x=null,P.hidden=!0,B.classList.add("hidden"),A.classList.remove("active"),void(O.innerHTML=`<p data-translate="ai_welcome">${e[t].ai_welcome}</p>`);try{x=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}),P.srcObject=x,await P.play(),F.classList.remove("hidden"),P.hidden=!1,N.hidden=!0,A.classList.add("active"),B.classList.remove("hidden"),O.innerHTML='<p>Caméra active. Appuyez sur le bouton <i class="fas fa-camera"></i> pour capturer.</p>'}catch(e){console.error("Erreur caméra:",e),alert("Impossible d'accéder à la caméra.")}}),B&&B.addEventListener("click",function(){if(!x)return;const e=document.createElement("canvas");e.width=P.videoWidth,e.height=P.videoHeight,e.getContext("2d").drawImage(P,0,0),L(e.toDataURL("image/jpeg"))}),T&&T.addEventListener("input",()=>{T.style.height="auto",T.style.height=T.scrollHeight+"px"}),document.getElementById("ai-advisor")&&async function(){E(!1),q.classList.remove("hidden"),b(10),O.textContent="Chargement des modèles IA...";try{"undefined"!=typeof mobilenet&&(await tf.setBackend("webgl"),w.image=await mobilenet.load({version:2,alpha:1}),console.log("Modèle IA Image chargé."),b(100)),w.ready=!0,O.innerHTML=`<p data-translate="ai_welcome">${e[t].ai_welcome}</p>`,E(!0)}catch(e){console.error("Échec du chargement des modèles:",e),O.textContent="Erreur lors du chargement des modèles IA."}finally{setTimeout(()=>q.classList.add("hidden"),1e3)}}()}if(refreshCsrfToken().catch(()=>{}),document.getElementById("account")){const z=document.getElementById("login-form"),U=document.getElementById("register-form"),H=document.getElementById("auth-section"),R=document.getElementById("register-section"),D=document.getElementById("login-message"),J=document.getElementById("register-message");document.getElementById("add-product-form"),document.getElementById("product-list"),document.getElementById("logout-btn");U&&U.addEventListener("submit",e=>{e.preventDefault();const t=document.getElementById("register-last-name").value.trim(),n=document.getElementById("register-first-name").value.trim(),o=document.getElementById("register-email").value.trim(),a=document.getElementById("register-phone").value.trim(),r=document.getElementById("register-region").value.trim(),s=document.getElementById("register-username").value.trim(),i=document.getElementById("register-password").value;/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(o)?/^\d{8,}$/.test(a)?csrfFetch("server/auth.php?action=register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:s,password:i,last_name:t,first_name:n,email:o,phone:a,region:r})}).then(e=>e.json()).then(e=>{e.csrfToken&&setCsrfToken(e.csrfToken),e.success?csrfFetch("server/auth.php?action=login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:s,password:i})}).then(e=>e.json()).then(e=>{e.csrfToken&&setCsrfToken(e.csrfToken),e.success?window.location.href=m:J&&(J.textContent="Compte créé, mais connexion impossible.")}):J&&(J.textContent=e.message||"Erreur lors de la création du compte.")}).catch(()=>{J&&(J.textContent="Erreur réseau.")}):J&&(J.textContent="Le numéro de téléphone doit contenir au moins 8 chiffres."):J&&(J.textContent="Email invalide.")}),z&&z.addEventListener("submit",e=>{e.preventDefault();const t=document.getElementById("login-username").value,n=document.getElementById("login-password").value;csrfFetch("server/auth.php?action=login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t,password:n})}).then(e=>e.json()).then(e=>{e.csrfToken&&setCsrfToken(e.csrfToken),e.success?window.location.href=m:D&&(D.textContent=e.message||"Nom d'utilisateur ou mot de passe incorrect.")}).catch(()=>{D&&(D.textContent="Erreur réseau.")})}),csrfFetch("server/auth.php?action=check",{method:"GET"}).then(e=>e.json()).then(e=>{setCsrfToken(e.csrfToken),e.loggedIn?window.location.href=m:(H&&H.classList.remove("hidden"),R&&R.classList.remove("hidden"))})}addProductForm&&addProductForm.addEventListener("submit",e=>{e.preventDefault();const t={name:document.getElementById("product-name").value,quantity:parseInt(document.getElementById("product-quantity").value)||0,phone:document.getElementById("product-phone").value,ph:parseFloat(document.getElementById("product-ph").value)||null,rain:parseFloat(document.getElementById("product-rain").value)||null,humidity:parseFloat(document.getElementById("product-humidity").value)||null,soil_humidity:parseFloat(document.getElementById("product-soil_humidity").value)||null,light:parseFloat(document.getElementById("product-light").value)||null,valve_open:document.getElementById("product-valve_open").checked?1:0,valve_angle:parseInt(document.getElementById("product-valve_angle").value)||0};csrfFetch("server/products.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(()=>{I(),addProductForm.reset()})}),logoutBtn&&logoutBtn.addEventListener("click",()=>{csrfFetch("server/auth.php?action=logout",{method:"POST"}).then(()=>{window.location.href=u})});const I=()=>{productList&&csrfFetch("server/products.php").then(e=>e.json()).then(e=>{if(productList.innerHTML="",Array.isArray(e)&&e.length>0)e.forEach(e=>{const t=document.createElement("tr");["name","quantity","ph","rain","humidity","soil_humidity","light"].forEach(n=>{const o=document.createElement("td");o.className="px-2",o.textContent=e[n]??"",t.appendChild(o)});const n=document.createElement("td");n.className="px-2";const o=document.createElement("button");o.className="button button--glass",o.textContent=1==e.valve_open?"Fermer":"Ouvrir",o.addEventListener("click",()=>{csrfFetch(`server/products.php?id=${e.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({valve_open:1==e.valve_open?0:1})}).then(I)}),n.appendChild(o),t.appendChild(n);const a=document.createElement("td");a.className="px-2";const r=document.createElement("input");r.type="number",r.value=e.valve_angle,r.className="form-input w-20",r.addEventListener("change",()=>{csrfFetch(`server/products.php?id=${e.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({valve_angle:parseInt(r.value)||0})}).then(I)}),a.appendChild(r),t.appendChild(a),productList.appendChild(t)});else{const e=document.createElement("tr"),t=document.createElement("td");t.colSpan=9,t.textContent="Aucun produit ajouté.",e.appendChild(t),productList.appendChild(e)}})};if(document.getElementById("profile")){const V=document.getElementById("profile-form"),$=document.getElementById("profile-last-name"),G=document.getElementById("profile-first-name"),W=document.getElementById("profile-email"),Q=document.getElementById("profile-phone"),Y=document.getElementById("profile-region"),K=document.getElementById("profile-message"),X=document.getElementById("dashboard-product-list"),Z=document.getElementById("refresh-products"),ee=document.getElementById("metric-active-modules"),te=document.getElementById("metric-avg-humidity"),ne=document.getElementById("metric-open-valves"),oe=document.getElementById("logout-btn"),ae=()=>{X&&csrfFetch("server/products.php").then(e=>e.json()).then(e=>{X.innerHTML="";const t=Array.isArray(e)?e:[];if(ee&&(ee.textContent=t.length.toString()),te){const e=t.map(e=>parseFloat(e.humidity)).filter(e=>!Number.isNaN(e)),n=e.length?e.reduce((e,t)=>e+t,0)/e.length:0;te.textContent=`${n.toFixed(1)}%`}if(ne&&(ne.textContent=t.filter(e=>1===Number(e.valve_open)).length.toString()),!t.length){const e=document.createElement("tr"),t=document.createElement("td");return t.colSpan=10,t.textContent="Aucun module IoT configuré pour le moment.",e.appendChild(t),void X.appendChild(e)}t.forEach(e=>{const t=document.createElement("tr");["name","quantity","ph","rain","humidity","soil_humidity","light"].forEach(n=>{const o=document.createElement("td");o.className="px-2 py-2",o.textContent=e[n]??"",t.appendChild(o)});const n=document.createElement("td");n.className="px-2 py-2";const o=document.createElement("button");o.className="button button--glass text-sm",o.textContent=1===Number(e.valve_open)?"Fermer":"Ouvrir",o.addEventListener("click",()=>{csrfFetch(`server/products.php?id=${e.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({valve_open:1===Number(e.valve_open)?0:1})}).then(ae)}),n.appendChild(o),t.appendChild(n);const a=document.createElement("td");a.className="px-2 py-2";const r=document.createElement("input");r.type="number",r.value=e.valve_angle??0,r.className="form-input w-20",r.addEventListener("change",()=>{csrfFetch(`server/products.php?id=${e.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({valve_angle:parseInt(r.value,10)||0})}).then(ae)}),a.appendChild(r),t.appendChild(a);const s=document.createElement("td");s.className="px-2 py-2";const i=document.createElement("button");i.className="button button--glass text-sm",i.textContent="Supprimer",i.addEventListener("click",()=>{confirm("Supprimer ce module ?")&&csrfFetch(`server/products.php?id=${e.id}`,{method:"DELETE"}).then(ae)}),s.appendChild(i),t.appendChild(s),X.appendChild(t)})})};(()=>{csrfFetch("server/user.php").then(e=>{if(!e.ok)throw new Error("Unauthorized");return e.json()}).then(e=>{$.value=e.last_name||"",G.value=e.first_name||"",W.value=e.email||"",Q.value=e.phone||"",Y.value=e.region||""}).catch(()=>{window.location.href=u})})(),ae(),Z&&Z.addEventListener("click",e=>{e.preventDefault(),ae()}),oe&&oe.addEventListener("click",()=>{csrfFetch("server/auth.php?action=logout",{method:"POST"}).then(()=>{window.location.href=u})}),V.addEventListener("submit",e=>{e.preventDefault();const t={last_name:$.value.trim(),first_name:G.value.trim(),email:W.value.trim(),phone:Q.value.trim(),region:Y.value.trim()};csrfFetch("server/user.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(e=>e.json()).then(e=>{e.success?(K.textContent="Profil mis à jour",K.classList.remove("text-red-500"),K.classList.add("text-green-500")):(K.textContent=e.message||"Erreur lors de la mise à jour.",K.classList.remove("text-green-500"),K.classList.add("text-red-500"))}).catch(()=>{K.textContent="Erreur réseau.",K.classList.remove("text-green-500"),K.classList.add("text-red-500")})})}if(document.getElementById("admin-dashboard")){const re=document.getElementById("stat-total-users"),se=document.getElementById("stat-total-products"),ie=document.getElementById("stat-open-valves"),le=document.getElementById("admin-user-list"),ce=document.getElementById("admin-product-list"),ue=document.getElementById("refresh-users"),de=document.getElementById("refresh-admin-products"),me=(e=[])=>{if(le){if(le.innerHTML="",!e.length){const e=document.createElement("tr"),t=document.createElement("td");return t.colSpan=5,t.textContent="Aucun utilisateur enregistré.",e.appendChild(t),void le.appendChild(e)}e.forEach(e=>{const t=document.createElement("tr");["last_name","first_name","email","region","role"].forEach(n=>{const o=document.createElement("td");o.className="px-2 py-2",o.textContent=e[n]??"",t.appendChild(o)}),le.appendChild(t)})}},_e=(e=[])=>{if(ce){if(ce.innerHTML="",!e.length){const e=document.createElement("tr"),t=document.createElement("td");return t.colSpan=5,t.textContent="Aucun module enregistré.",e.appendChild(t),void ce.appendChild(e)}e.forEach(e=>{const t=document.createElement("tr");[e.username,e.name,e.quantity,e.humidity??"-",1===Number(e.valve_open)?"Ouverte":"Fermée"].forEach(e=>{const n=document.createElement("td");n.className="px-2 py-2",n.textContent=e??"",t.appendChild(n)}),ce.appendChild(t)})}},pe=()=>{csrfFetch("server/admin.php?action=stats").then(e=>e.json()).then(e=>{if(!e.success)return;const t=e.data||{};re&&(re.textContent=(t.users??0).toString()),se&&(se.textContent=(t.products??0).toString()),ie&&(ie.textContent=(t.openValves??0).toString())})},he=()=>{csrfFetch("server/admin.php?action=users").then(e=>e.json()).then(e=>{e.success&&me(e.data||[])})},ge=()=>{csrfFetch("server/admin.php?action=products").then(e=>e.json()).then(e=>{e.success&&_e(e.data||[])})};ue&&ue.addEventListener("click",()=>he()),de&&de.addEventListener("click",()=>ge()),pe(),he(),ge()}const C=document.getElementById("contact-form");if(C){const ve=document.getElementById("contact-form-feedback"),fe=(n,o)=>e[t]&&e[t][n]||o,ye=(e,t="neutral")=>{if(!ve)return;ve.classList.remove("text-red-500","text-brand-green-400","text-text-300");let n="text-text-300";"success"===t&&(n="text-brand-green-400"),"error"===t&&(n="text-red-500"),ve.classList.add(n),ve.textContent=e};C.addEventListener("submit",e=>{e.preventDefault();const t=new FormData(C);ye(fe("contact_sending","Envoi du message…"),"neutral"),csrfFetch("server/contact.php",{method:"POST",body:t}).then(e=>e.json()).then(e=>{const t=e.message||fe(e.success?"contact_success_message":"contact_error_message",e.success?"Message envoyé avec succès!":"Impossible d'envoyer le message.");ye(t,e.success?"success":"error"),e.success&&C.reset()}).catch(()=>{ye(fe("contact_network_error","Erreur réseau."),"error")})})}try{AOS.init({duration:800,once:!0,offset:50})}catch(be){console.error("AOS init failed",be)}});
